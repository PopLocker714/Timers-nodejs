<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Timers</title>
    <link rel="icon" type="image/png" href="[[ path.public ]]/clock.png">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/uikit@3.5.4/dist/css/uikit.min.css" />

    <style>
      [v-cloak] {
        display: none;
      }
      .mono {
        font-family: monospace;
      }
    </style>
  </head>
  <body>
    [% if user %]
      <section id="app" v-cloak class="uk-container uk-margin-top uk-margin-bottom">
        <p>
          <strong>
            User: [[ user.username ]].
            <a href="/logout">Log out</a>
          </strong>
        </p>
        <p>
          <form v-on:submit.prevent="createTimer">
            <input v-model="desc" class="uk-input" placeholder="Type description...">
            <p>
              <button v-bind:disabled="!desc" id="start-timer" class="uk-button uk-button-primary">
                <span uk-icon="play"></span> Start timer
              </button>
            </p>
          </form>
        </p>
        <div>
          <h2>Active timers:</h2>
          <ul class="uk-list">
            <li v-for="t in activeTimers" :key="t.id">
              <span uk-icon="close" v-on:click="stopTimer(t.id)"></span>
              <span class="uk-text-primary mono">{{ formatDuration(t.progress) }}</span>
              <strong class="uk-text-emphasis">{{ t.description }}</strong>
              <span class="uk-text-muted mono">{{ formatTime(t.start) }}</span>
            </li>
          </ul>
        </div>
        <div>
          <h2>Old timers:</h2>
          <ul id="past-timers" class="uk-list">
            <li v-for="t in oldTimers" :key="t.id">
              <span class="uk-text-primary mono">{{ formatDuration(t.duration) }}</span>
              <strong class="uk-text-emphasis">{{ t.description }}</strong>
              (<span class="uk-text-muted mono">{{ formatTime(t.start) }}</span>
              &ndash;
              <span class="uk-text-muted mono">{{ formatTime(t.end) }}</span>)
            </li>
          </ul>
        </div>
      </section>

      <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.4/dist/js/uikit.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/uikit@3.5.4/dist/js/uikit-icons.min.js"></script>
      <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>

      //<script type="text/javascript" src="[[ path.public ]]/main.js"></script>
      <script>
      (() => {
  const createWs = (context) => {
    const wsProto = location.protocol === "http:" ? "ws:" : "wss:";
    const ws = new WebSocket(`${wsProto}//${location.host}`);

    /* ws.addEventListener("open", () => {
      console.log("WebSocket connection established");
    }); */

    ws.addEventListener("message", (event) => {
      let data = null;
      try {
        data = JSON.parse(event.data);
      } catch (error) {
        console.error(error);
        return;
      }

      if (data.type === "OLD_TIMERS") {
        context.oldTimers = data.timers;
      }

      if (data.type === "ACTIVE_TIMERS") {
        context.activeTimers = data.timers;
      }
    });

    ws.addEventListener("close", () => {
      console.log("WebSocket connection closed");
    });

    return ws;
  };

  const notification = (config) =>
    UIkit.notification({
      pos: "top-right",
      timeout: 5000,
      ...config,
    });

  const alert = (message) =>
    notification({
      message,
      status: "danger",
    });

  const info = (message) =>
    notification({
      message,
      status: "success",
    });

  const fetchJson = (...args) =>
    fetch(...args)
      .then((res) =>
        res.ok
          ? res.status !== 204
            ? res.json()
            : null
          : res.text().then((text) => {
              throw new Error(text);
            })
      )
      .catch((err) => {
        alert(err.message);
      });

  new Vue({
    el: "#app",
    data: {
      desc: "",
      activeTimers: [],
      oldTimers: [],
    },
    methods: {
      fetchActiveTimers() {
        if (!this.ws) return console.log("no ws");
        this.ws.send(JSON.stringify({ type: "ACTIVE_TIMERS" }));
        /* fetchJson("/api/timers?isActive=true").then((activeTimers) => {
          this.activeTimers = activeTimers;
        }); */
      },
      fetchOldTimers() {
        if (!this.ws) return console.log("no ws");
        this.ws.send(JSON.stringify({ type: "OLD_TIMERS" }));
        /* fetchJson("/api/timers?isActive=false").then((oldTimers) => {
          this.oldTimers = oldTimers;
        }); */
      },
      createTimer() {
        const description = this.desc;
        this.desc = "";
        fetchJson("/api/timers", {
          method: "post",
          headers: {
            "Content-Type": "application/json",
          },
          body: JSON.stringify({ description }),
        }).then(({ id }) => {
          info(`Created new timer "${description}" [${id}]`);
          this.fetchActiveTimers();
        });
      },
      stopTimer(id) {
        fetchJson(`/api/timers/${id}/stop`, {
          method: "post",
        }).then(() => {
          info(`Stopped the timer [${id}]`);
          this.fetchActiveTimers();
          this.fetchOldTimers();
        });
      },
      formatTime(ts) {
        return new Date(ts).toTimeString().split(" ")[0];
      },
      formatDuration(d) {
        d = Math.floor(d / 1000);
        const s = d % 60;
        d = Math.floor(d / 60);
        const m = d % 60;
        const h = Math.floor(d / 60);
        return [h > 0 ? h : null, m, s]
          .filter((x) => x !== null)
          .map((x) => (x < 10 ? "0" : "") + x)
          .join(":");
      },
    },
    created() {
      let isOpen = false;
      this.ws = createWs(this);
      this.ws.addEventListener("open", () => {
        isOpen = true;
      });

      const interval = setInterval(() => {
        if (isOpen) {
          this.fetchActiveTimers();
          setInterval(() => {
            this.fetchActiveTimers();
          }, 1000);
          this.fetchOldTimers();
          clearInterval(interval);
        }
      }, 200);
    },
  });
})();
      </script>
    [% else %]
      <section class="uk-container uk-margin-top uk-margin-bottom">
        [% if authError %]
          <div class="uk-alert uk-alert-danger">
            <p>[[ authError ]]</p>
          </div>
        [% endif %]

        <h2>Login</h2>
        <form method="POST" action="/login" enctype="application/x-www-form-urlencoded">
          <p><input type="text" name="username" class="uk-input"></p>
          <p><input type="password" name="password" class="uk-input"></p>
          <p><button class="uk-button uk-button-primary">Login</button></p>
        </form>

        <h1>OR</h1>
        <h2>Signup</h2>
        <form method="POST" action="/signup" enctype="application/x-www-form-urlencoded">
          <p><input type="text" name="username" class="uk-input"></p>
          <p><input type="password" name="password" class="uk-input"></p>
          <p><button class="uk-button uk-button-primary">Signup</button></p>
        </form>
      </section>
    [% endif %]
  </body>
</html>
